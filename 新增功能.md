燃料电池汽车故障诊断系统：模型集成与落地技术路线图

第一部分：关于训练数据的核心决策

1. 现状分析

你目前拥有：

模型：基于公开数据集（Open Datasets）训练完成。

环境：基于 ControlCAN.dll 和 Python 后端的实时数据采集系统。

2. 为什么直接使用可能有风险？

公开数据集（如 IEEE PHM Challenge 数据或某些实验室标准数据）通常是在非常受控的环境下采集的，其采样频率、传感器噪声、**数据量纲（单位）**与你实际的燃料电池硬件可能完全不同。

举例：公开数据集的电压可能是 0.0V - 1.0V 的归一化数据，而你的 CAN 总线读上来的是 0 - 1000mV 的整数。如果直接输入，模型会输出完全错误的预测。

3. 解决方案：迁移学习 (Transfer Learning)

不需要从零开始训练。 建议采取以下策略：

保留特征提取层：保留现有模型的前几层（如果是深度学习模型），因为它们已经学会了如何识别通用的波形特征。

采集校准数据：使用你的软件连接实际设备（或高保真仿真器），采集一段真实运行的数据（哪怕只有几十分钟）。

微调 (Fine-tuning)：冻结模型前层参数，用新采集的数据只训练最后的全连接层（分类层）。

第二部分：详细实施步骤 (Step-by-Step)

阶段一：数据对齐 (Data Alignment) —— 最关键的一步

在将模型放入 server.py 之前，必须确保输入数据格式一致。

特征映射：

打开论文/模型文档，列出模型需要的输入特征（例如：[电流, 电压, 温度, 氢气压力]）。

在 backend/can_protocol.py 中，找到对应的 CAN ID 解析逻辑，确保能提取到这些字段。

预处理管道 (Preprocessing Pipeline)：

在 Python 中实现与模型训练时完全一致的预处理函数。

代码示例（建议添加到 backend/utils.py）：

import numpy as np

def preprocess_live_data(raw_values):
    # 1. 单位转换 (例如 mV 转 V)
    voltage = raw_values['voltage'] / 1000.0
    current = raw_values['current']

    # 2. 归一化 (必须使用训练集的均值和标准差！)
    # 这些数字来自于你训练公开数据集时的统计
    mean_val = 0.5 
    std_val = 0.1
    normalized_voltage = (voltage - mean_val) / std_val

    # 3. 维度调整 (Reshape for model, e.g., LSTM needs [1, time_steps, features])
    return np.array([[normalized_voltage, current]])


阶段二：后端集成 (Backend Integration)

修改 backend/server.py，让它成为推理引擎。

加载模型：

在服务器启动时（if __name__ == '__main__': 之前）加载模型，避免每次请求都重新加载。

# backend/server.py 顶部
import joblib # 或 tensorflow/pytorch

print("正在加载诊断模型...")
diagnosis_model = joblib.load('models/fcu_fault_model.pkl')
print("模型加载完成")


实时推理：

在 WebSocket 的广播循环中插入推理逻辑。

注意性能：如果模型推理太慢（>100ms），不要在主线程做，建议开启一个单独的 Thread 进行推理，将结果存入全局变量，WebSocket 线程只负责读取。

阶段三：前端可视化与交互 (UI/UX)

作为前端设计，这是你的主战场。你需要让用户“信任”这个模型。

置信度展示 (Confidence Level)：

不要只显示“故障/正常”。

UI设计：显示“故障概率：85%”。如果概率低于 60%，显示灰色或黄色警告，而不是红色警报，避免误报导致用户疲劳。

增加“人工反馈”功能 (Human-in-the-Loop)：

这是论文的加分项，也是解决数据不足的工程手段。

功能：当系统报警时，在 AlarmDrawer.tsx 中增加两个按钮：

✅ [确认故障]：标记该数据片段为“真实故障”。

❌ [误报]：标记该数据片段为“正常”。

后端处理：将用户点击时前后 10 秒的原始数据保存到 backend/dataset/labeled/ 目录下。这将成为你下一轮训练最宝贵的“金标准数据”。

阶段四：验证与测试

回放测试：

不要直接上真车/真电堆测试（有风险）。

编写一个脚本，读取公开数据集的 CSV 文件，模拟 CAN 数据流发送给 server.py，观察前端是否能正确报警。